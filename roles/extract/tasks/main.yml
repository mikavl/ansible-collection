---

- name: extract | assert facts
  ansible.builtin.assert:
    that:
      - extract_src is defined
      - extract_dest is defined

- name: extract | create temporary directory
  ansible.builtin.tempfile:
    state: directory
  register: extract_tempfile
  changed_when: False

- block:

    - name: extract | unarchive
      ansible.builtin.unarchive:
        src: "{{ extract_src }}"
        dest: "{{ extract_tempfile.path }}"
        remote_src: True
      changed_when: False

    - name: extract | find extracted files
      ansible.builtin.find:
        path: "{{ extract_tempfile.path }}{{ extract_subpath }}"
        patterns: "{{ extract_patterns }}"
      register: extract_find

    - name: extract | copy files
      ansible.builtin.copy:
        src: "{{ item.path }}"
        dest: "{{ extract_dest }}/{{ extract_filename }}"
        remote_src: True
        mode: "{{ extract_mode }}"
      loop: "{{ extract_find.files }}"
      loop_control:
        label: "{{ extract_filename }}"
      vars:
        extract_filename: "{{ item.path | basename }}"

  always:

    - name: extract | remove temporary directory
      ansible.builtin.file:
        path: "{{ extract_tempfile.path }}"
        state: absent
